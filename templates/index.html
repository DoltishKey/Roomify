<!doctype html>
<html>
    <head>
        <title>Roomify | Start</title>
        <meta charset="UTF-8">
        <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
        <script src="{{ url_for('static', filename='jquery.js') }}"></script>
        <script src="{{ url_for('static', filename='recorder.js') }}"></script>
    </head>
    <body>
        <h1>Roomify</h1>
        <div id="text_container">
            <form action="" method="post" id="new_text_request">
                <label for="new_name">Vad vill du g√∂ra?</label>
                <input type="text" name="text_request"  id="text_request">
                <input type="submit">
            </form>
        </div>
        <div id="recorder_div">
            <h2>Recorder</h2>
            <button onclick="startRecording(this);">record</button>
            <button onclick="stopRecording(this);" disabled>stop</button>

            <h2>Recordings</h2>
            <ul id="recordingslist"></ul>

            <h2>Log</h2>
        </div>
        <pre id="log"></pre>

        <script>
            $(document).ready(function() {
                send_data()
            });



            function send_data(){
                $("#new_text_request").submit(function(e){
                    e.preventDefault();
                    input = $('#text_request').val()
                    console.log(input);
                    $.ajax({
                        url: '/new_text_request',
                        method: 'POST',
                        data:$(this).serialize(),
                        success: function(response) {
                            __log(response);
                        }
                    });

                });
            }
        </script>
        <script>
            function __log(e, data) {
              log.innerHTML += "\n" + e + " " + (data || '');
            }
            var audio_context;
            var recorder;


            function startUserMedia(stream) {
              var input = audio_context.createMediaStreamSource(stream);
              __log('Media stream created.');
              // Uncomment if you want the audio to feedback directly
              //input.connect(audio_context.destination);
              //__log('Input connected to audio context destination.');
              recorder = new Recorder(input);
              __log('Recorder initialised.');
            }

            function startRecording(button) {
              recorder && recorder.record();
              button.disabled = true;
              button.nextElementSibling.disabled = false;
              __log('Recording...');
            }

            function stopRecording(button) {
              recorder && recorder.stop();
              button.disabled = true;
              button.previousElementSibling.disabled = false;
              __log('Stopped recording.');

              // create WAV download link using audio data blob
              createDownloadLink();

              recorder.clear();
            }


            function b64EncodeUnicode(str) {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            }

            function createDownloadLink() {
              recorder && recorder.exportWAV(function(blob) {
                var url = URL.createObjectURL(blob);
                var li = document.createElement('li');
                var au = document.createElement('audio');
                var hf = document.createElement('a');

                var reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function() {
                    base64data = reader.result;

                    var encodedData = window.btoa(base64data);
                    $.ajax({
                        url: '/new_speech_request',
                        method: 'POST',
                        data:{'sound':encodedData},
                        success: function(response) {
                            __log(response)
                        }
                    });
                }

                au.controls = true;
                au.src = url;
                hf.href = url;
                hf.download = new Date().toISOString() + '.wav';
                hf.innerHTML = hf.download;
                li.appendChild(au);
                li.appendChild(hf);
                recordingslist.appendChild(li);
              });
            }




            window.onload = function init() {
              try {
                // webkit shim
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
                window.URL = window.URL || window.webkitURL;

                audio_context = new AudioContext;
                __log('Audio context set up.');
                __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
                if (navigator.getUserMedia){
                    $('#recorder_div').show()
                    $('#text_container').hide()
                }
                else{
                    fallback()
                }
              } catch (e) {
                fallback()
              }

              if (navigator.getUserMedia){
                  navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
                      fallback()
                  });
                }
            };

            function fallback(){
                $('#recorder_div').hide();
                $('#text_container').show();
            }
        </script>
    </body>
</html>
