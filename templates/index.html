<!doctype html>
<html>
    <head>
        <title>Roomify | Start</title>
        <meta charset="UTF-8">
        <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet">
        <script src="{{ url_for('static', filename='jquery.js') }}"></script>
        <script src="{{ url_for('static', filename='recorder.js') }}"></script>
    </head>
    <body>
        <h1>Roomify</h1>
        <h2>Book grouprooms by speech</h2>
        <div id="text_container">
            <form action="" method="post" id="new_text_request">
                <label for="new_name">Vad vill du göra?</label>
                <input type="text" name="text_request"  id="text_request">
                <input type="submit">
            </form>
        </div>
        <div id="recorder_div">
            <h4>Tap to capture booking</h4>
            <div id="recorder">
                <div></div>
            </div>
            <button onclick="startRecording(this);">record</button>
            <button onclick="stopRecording(this);" disabled>stop</button>

            <h2>Recordings</h2>
            <ul id="recordingslist"></ul>

            <h2>Log</h2>
        </div>

        <div id="confirm_booking">
            <h3> We will book a room for you</h3>

            <div id="date">
                <p></p>
            </div>

            <div id="time">
                <p></p>
            </div>

            <div id="location">
                <p></p>
            </div>

        <div id="confirm_button"></div>

        </div>
        <pre id="log"></pre>
        <script>
            function confirm_booking(){
                $('#confirm_button').click(function(){
                    var value = $(this).text();
                     var location = $('#location').find('p').text();
                     var time = $('#time').find('p').text();
                     var date = $('#date').find('p').text();

                    $.ajax({
                        url: '/grouprooms',
                        method: 'POST',
                        data:{'sound':encodedData},
                        dataType: "json"
                    });
                });
            }
        </script>

        <script>
            $(document).ready(function() {
                send_data()
            });



            function send_data(){
                $("#new_text_request").submit(function(e){
                    e.preventDefault();
                    input = $('#text_request').val()
                    console.log(input);
                    $.ajax({
                        url: '/new_text_request',
                        method: 'POST',
                        data:$(this).serialize(),
                        success: function(response) {
                            __log(response);
                        }
                    });

                });
            }
        </script>
        <script>
            function __log(e, data) {
              log.innerHTML += "\n" + e + " " + (data || '');
            }
            var audio_context;
            var recorder;


            function startUserMedia(stream) {
              var input = audio_context.createMediaStreamSource(stream);
              __log('Media stream created.');
              // Uncomment if you want the audio to feedback directly
              //input.connect(audio_context.destination);
              //__log('Input connected to audio context destination.');
              recorder = new Recorder(input);
              __log('Recorder initialised.');
            }

            function startRecording(button) {
              recorder && recorder.record();
              button.disabled = true;
              button.nextElementSibling.disabled = false;
              __log('Recording...');
            }

            function stopRecording(button) {
              recorder && recorder.stop();
              button.disabled = true;
              button.previousElementSibling.disabled = false;
              __log('Stopped recording.');

              // create WAV download link using audio data blob
              createDownloadLink();

              recorder.clear();
            }


            function b64EncodeUnicode(str) {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            }

            function createDownloadLink() {
                recorder && recorder.exportWAV(function(blob) {
                    var url = URL.createObjectURL(blob);
                    var li = document.createElement('li');
                    var au = document.createElement('audio');
                    var hf = document.createElement('a');

                    var reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = function() {
                        base64data = reader.result;
                        var encodedData = window.btoa(base64data);
                        $.ajax({
                            url: '/new_speech_request',
                            method: 'POST',
                            data:{'sound':encodedData},
                            dataType: "json",
                            success: function(response) {
                                // Location, date och time skrivs ut + tillhörande knapper
                                if(response[0]['errors'].indexOf('location')> -1){
                                    $('#location').find('p').text('where?')
                                    $('#location').append("<button class='location'>Niagara</button>")
                                    $('#location').append("<button class='location'>Orkanen</button>")
                                }
                                $('#date').find('p').text(response[1]['date'])
                                var timeslots =
                                    ['08:15-10:00',
                                    '10:15-13:00',
                                    '13:15-15:00',
                                    '15:15-17:00',
                                    '17:15-20:00']
                                var prime = timeslots[response[1]['primary_slot']]
                                $('#time').find('p').text(prime)

                                if(response[1]['sec_slot'] != null){
                                    var secondary = timeslots[response[1]['sec_slot']]
                                    $('#time').append("<button class='time'>"+ prime +"</button>")
                                    $('#time').append("<button class='time'>"+ secondary +"</button>")
                                }
                                $('.location').click(function(){
                                    var value = $(this).text();
                                    $('#location').find('p').text(value);
                                });
                                $('.time').click(function(){
                                    var value = $(this).text();
                                    $('#time').find('p').text(value);
                                });
                                confirm_booking()
                            }
                        });
                    }

                au.controls = true;
                au.src = url;
                hf.href = url;
                hf.download = new Date().toISOString() + '.wav';
                hf.innerHTML = hf.download;
                li.appendChild(au);
                li.appendChild(hf);
                recordingslist.appendChild(li);
              });
            }




            window.onload = function init() {
              try {
                // webkit shim
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
                window.URL = window.URL || window.webkitURL;

                audio_context = new AudioContext;
                __log('Audio context set up.');
                __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
                if (navigator.getUserMedia){
                    $('#recorder_div').show()
                    $('#text_container').hide()
                }
                else{
                    fallback()
                }
              } catch (e) {
                fallback()
              }

              if (navigator.getUserMedia){
                  navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
                      fallback()
                  });
                }
            };

            function fallback(){
                $('#recorder_div').hide();
                $('#text_container').show();
            }
        </script>
    </body>
</html>
